# 调试

## strace

1. 追踪系统调用
2. -c 统计进程所有系统调用
3. -p 追踪正在运行的进程

## gdb

1. 程序需要 -g 编译，加入调试信息
2. gdb
   1. gdb program
   2. gdb program core  //use core dump
   3. gdb program pid   //attach

|        |                      |
| :----- | :------------------- |
| l      | 列出函数代码及其行数 |
| b 16   | 在代码16行处设置断点 |
| b func | 在函数func处设置断点 |
| r      | 运行程序             |
| n      | 单条执行语句         |
| p i    | 打印i变量的值        |
| bt     | 查看函数的堆栈       |
| finish | 退出函数             |
| q      | 结束调试             |

设置coredump

```bash
// 查看coredump file path, 默认core，即当前目录
cat /proc/sys/kernel/core_pattern

// 查看coredump文件最大大小
ulimit -c
// 修改 /etc/profile
ulimit -c unlimited

// 防止同一程序多次coredump覆盖
echo "data/coredump/core.%e.%p" > /proc/sys/kernel/core_pattern
```

coredump 原因

1. 内存越界
2. 多线程程序使用线程不安全函数
3. 多线程读写数据未加锁
4. 非法指针
5. 堆栈溢出

## valgrind

https://www.valgrind.org/

![valgrind](./imgs/valgrind.jpg)

内核（core）类似于一个虚拟的CPU环境，这样当内存中的某个字节被加载到真实的CPU中时，该字节对应的V bit也被加载到虚拟的CPU环境中

![valgrind table](./imgs/valgrind2.jpg)
